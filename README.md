# README
### Stack
* [Wordpress](https://wordpress.org) версия: **5.2.2**.
* [PHP-FPM](https://www.php.net/downloads.php#v7.2.19) версия: **7.2.19**.
* [NGINX](https://nginx.org/en/CHANGES-1.16) версия: **1.16.0**.
* [Percona Server](https://www.percona.com/downloads/Percona-Server-5.7/LATEST/binary/tarball/) версия: **5.7.26**.


# Workflow
### Переменные
Для домена `www.example.com` значения будут следующие:
- `example-com` -- Название Git репозитория;
- `example-com` -- Значение переменной `WP_PROJECT_ID` в `.env` файле;
- `example-com` -- Имя пользователя и имя базы данных для доступа к MySQL;
___
### Развертывание проекта
#### I этап. Подготовка:
+ Запустить задачу по [инициализации проекта](https://jenkins.devmwl.com/job/PD-SEO/job/pd-seo-init/), где `PROJECT_FQDN` - полное доменное имя проекта (без `www.`). Пример: Для домена `www.example.com` значение будет `example.com`.
+ [Продублировать](https://help.github.com/en/articles/duplicating-a-repository) репозиторий [PD-template](https://github.com/pd-seo/pd-template).
+ [Удалить](https://stackoverflow.com/questions/13716658/how-to-delete-all-commit-history-in-github/26000395#26000395) из нового репозитория все коммиты.
+ Дать `read/write` доступ к новому репозиторию для группы [developers](https://github.com/orgs/pd-seo/teams/developers).
+  Настроить проект:
    + Клонируем себе новый репозиторий.
    + Настройка приложения для локальной разработки:
        + В `.env` файле задать корректное значение для переменной `WP_PROJECT_ID`.
        + В `.env` файле прописать пароль для доступк к БД в переменную `WP_DB_PASS`.
        + В `.env` файле задать значение переменной `UID` равное выводу комманды `id -u $(whoami)` в терминале (По умолчанию для систем на базе GNU/Linux значение будет равно `1000`).
    + Настроить продуктовый файл конфигурации `nginx`:
        + В файле `docker/nginx/prod.conf:15` корректно указать значение `server_name`. Пример: `server_name example.com www.example.com;`.
        + В файле `docker/nginx/prod.conf:89` корректно указать значение `$gcs_bucket`. Пример: `set $gcs_bucket "example-com";`.
    + Запустить приложение: **`docker-compose up -d --build`**.
    + Открыть [http://localhost/](http://localhost/):
        + Установить Wordpress.
        + **Настройки** > *Общее*:
            + Удалить все из поля `Краткое описание`.
        + **Настройки** > *Чтение*:
            + `На главной странице отображать` -> `Статическую страницу`.
            + `На страницах блога отображать не более` -> `9999`.
            + `В RSS-лентах отображать последние` -> `9999`.
            + `Видимость для поисковых систем` -> `[+]`.
        +  **Настройки** > *Обсуждение*:
            + `Настройки для статьи по умолчанию` -> Снять все чекбоксы.
            + `Отображение аватаров` -> `[ ]`.
        + **Настройки** > *Медиафайлы*:
            + Все значения поставить `0` и снять все чекбоксы.
        + **Настройки** > *Постоянные ссылки*:
            + `Общие настройки` выбрать `Произвольно` и указать `/%postname%/`.
#### II этап. Разработка
+ На данном этапе происходит разработка проекта и вносятся необходимые изменения в исходный код приложения.
+ Если для локальной разработки необходимо внести правки в БД уже работающего проекта, то для начала необходимо снять её свежий дамп. Для этого необходимо запустить задачу [Database export](https://jenkins.devmwl.com/job/PD-SEO/job/db-import-export/). После этого свежий бекап появтся в git репозитории проекта в папке `/docker/mysql/init`.
#### III этап. Деплой на продуктовое окружение
После того, как все изменения в код и базу данных внесены данное приложение можно деплоить на продуктовое окружение.

+ Выполнить бэкап БД:
    + `docker-compose exec mysql bash`
    + `mysqldump -uroot -p$MYSQL_ROOT_PASSWORD $MYSQL_DATABASE > /docker-entrypoint-initdb.d/init.sql`
+ `git commit` и `git push` в необходимую ветку.
+ Запустить задачу [Deploy](https://jenkins.devmwl.com/job/PD-SEO/job/pd-seo-deploy/) в Jenkins, где указать:
    + `PROJECT_FQDN` - Полное доменное имя проекта (без `www.`). Пример: Для домена `www.example.com` значение будет `example.com`.
    + `GIT_BRANCH` - Ветка на базе которой будет собрано приложение. По умолчанию это `master`.
+ **[!!!]Только при условии, что в БД были внесены правки во время разработки или что эта задача запускается первый раз для данного проекта[!!!]**
Запустить задачу [Database import](https://jenkins.devmwl.com/job/PD-SEO/job/db-import-export/), где:
    +  `PROJECT_FQDN` - Полное доменное имя проекта (без `www.`). Пример: Для домена `www.example.com` значение будет `example.com`.
    + `ACTION` -> `import`
+ *Cleanup*
    + `docker-compose down`
___
#### Работа с проектом в дальнейшем
В дальнейшем повторяются только этапы `Разработка` и `Деплой на продуктовое окружение`, этап `Подготовка` выполняется только один раз.
